name: AMDSMI CI

on:
  pull_request:
    branches: [amd-staging, amd-mainline, release/rocm-rel-*]
  push:
    branches: [amd-staging, amd-mainline, release/rocm-rel-*]
  workflow_dispatch:

env:
  DEBIAN_FRONTEND: noninteractive
  DEBCONF_NONINTERACTIVE_SEEN: true
  BUILD_TYPE: Release
  ROCM_DIR: /opt/rocm

jobs:
  debian-buildinstall:
    name: Build
    runs-on:
      - self-hosted
      - ${{ vars.RUNNER_TYPE }}
    continue-on-error: true
    strategy:
      matrix:
        os: [Ubuntu20, Ubuntu22, Debian10]
    container:
      image: ${{ vars[format('{0}_DOCKER_IMAGE', matrix.os)] }}
      options: --privileged

    steps:
      - uses: actions/checkout@v4
        with:
          clean: false

      - name: Build AMDSMI
        run: |
          set -e
          echo 'Building on ${{ matrix.os }}'
          BUILD_FOLDER=$GITHUB_WORKSPACE/build
          rm -rf $BUILD_FOLDER
          mkdir -p $BUILD_FOLDER
          cd $BUILD_FOLDER
          cmake $GITHUB_WORKSPACE -DBUILD_TESTS=ON -DENABLE_ESMI_LIB=ON
          make -j $(nproc)
          make package
          echo "Build completed on ${{ matrix.os }}"

      - name: Install AMDSMI
        run: |
          cd $GITHUB_WORKSPACE/build
          apt update
          apt install -y ./amd-smi-lib*99999-local_amd64.deb
          ln -s /opt/rocm/bin/amd-smi /usr/local/bin

          # Verify Installation
          echo 'Verifying installation:'
          amd-smi version
          python3 -m pip list | grep amd
          python3 -m pip list | grep pip
          python3 -m pip list | grep setuptools
          echo 'Completed installation on ${{ matrix.os }}'

      - name: Uninstall
        if: always()
        run: |
          set -e
          echo 'Uninstalling on ${{ matrix.os }}'
          apt remove -y amd-smi-lib || true
          rm -f /usr/local/bin/amd-smi
          if [ -d /opt/rocm/share/amd_smi ]; then
            echo '/opt/rocm/share/amd_smi exists. Removing.'
            rm -rf /opt/rocm/share/amd_smi
          fi
          echo 'Uninstall done on ${{ matrix.os }}'

  debian-test:
    name: Tests
    needs: debian-buildinstall
    runs-on:
      - self-hosted
      - ${{ vars.RUNNER_TYPE }}
    continue-on-error: true
    strategy:
      matrix:
        os: [Ubuntu20, Ubuntu22, Debian10]
    container:
      image: ${{ vars[format('{0}_DOCKER_IMAGE', matrix.os)] }}
      options: --privileged

    steps:
      - uses: actions/checkout@v4
        with:
          clean: false

      - name: Build and Install for Test
        run: |
          set -e
          echo 'Building for test on ${{ matrix.os }}'
          BUILD_FOLDER=$GITHUB_WORKSPACE/build
          rm -rf $BUILD_FOLDER
          mkdir -p $BUILD_FOLDER
          cd $BUILD_FOLDER
          cmake $GITHUB_WORKSPACE -DBUILD_TESTS=ON -DENABLE_ESMI_LIB=ON
          make -j $(nproc)
          make package

          echo 'Installing for test on ${{ matrix.os }}'
          apt update
          apt install -y $BUILD_FOLDER/amd-smi-lib*99999-local_amd64.deb
          ln -s /opt/rocm/bin/amd-smi /usr/local/bin
          echo 'Install done for test on ${{ matrix.os }}'

      - name: AMDSMI Command Tests
        shell: bash
        run: |
          set -e
          echo "Running AMDSMI commands on ${{ matrix.os }}"
          mkdir -p /tmp/test-results-${{ matrix.os }}
          commands=(
            "amd-smi version"
            "amd-smi list"
            "amd-smi static"
            "amd-smi firmware"
            "amd-smi bad-pages"
            "amd-smi metric"
            "amd-smi process"
            "amd-smi topology"
            "amd-smi monitor"
            "amd-smi xgmi"
            "amd-smi partition"
          )
          for cmd in "${commands[@]}"; do
            echo "Running: $cmd"
            if ! $cmd > /tmp/test-results-${{ matrix.os }}/$(echo $cmd | tr ' ' '_').log 2>&1; then
              echo "Command '$cmd' failed."
              cat /tmp/test-results-${{ matrix.os }}/$(echo $cmd | tr ' ' '_').log
              exit 1
            else
              echo "$cmd passed."
            fi
          done
          echo "AMDSMI commands done on ${{ matrix.os }}"

      - name: Run AMDSMI, Python, and Example Tests
        shell: bash
        run: |
          set -e
          echo 'Running other tests on ${{ matrix.os }}'

          # AMDSMI Tests
          echo 'AMDSMI tests'
          cd /opt/rocm/share/amd_smi/tests
          source amdsmitst.exclude
          ./amdsmitst --gtest_filter="-$(echo ${BLACKLIST_ALL_ASICS})" > /tmp/test-results-${{ matrix.os }}/amdsmi_tests.log 2>&1
          if [ $? -ne 0 ]; then
            echo "AMDSMI tests failed"
            exit 1
          fi
          echo "AMDSMI tests done"

          # Python Tests
          echo 'Python tests'
          cd /opt/rocm/share/amd_smi/tests/python_unittest
          ./integration_test.py -v > /tmp/test-results-${{ matrix.os }}/integration_test_output.txt 2>&1
          ./unit_tests.py -v > /tmp/test-results-${{ matrix.os }}/unit_test_output.txt 2>&1
          echo "Python tests done"

          # Example Tests
          echo 'Example tests'
          cd $GITHUB_WORKSPACE/example
          rm -rf build
          cmake -B build -DENABLE_ESMI_LIB=OFF
          make -C build -j $(nproc)
          cd build
          ./amd_smi_drm_ex > /tmp/test-results-${{ matrix.os }}/amd_smi_drm_ex.log 2>&1 || echo 'amd_smi_drm_ex failed'
          ./amd_smi_nodrm_ex > /tmp/test-results-${{ matrix.os }}/amd_smi_nodrm_ex.log 2>&1 || echo 'amd_smi_nodrm_ex failed'
          echo "Example tests done"

      - name: AMDSMI Test Results
        if: always()
        run: |
          echo "Displaying AMDSMI test results for ${{ matrix.os }}"
          cat /tmp/test-results-${{ matrix.os }}/amdsmi_tests.log || echo "No AMDSMI test results found for ${{ matrix.os }}"

      - name: Integration Test Results
        if: always()
        run: |
          echo "Displaying Integration test results for ${{ matrix.os }}"
          cat /tmp/test-results-${{ matrix.os }}/integration_test_output.txt || echo "No integration test results found for ${{ matrix.os }}"

      - name: Unit Test Results
        if: always()
        run: |
          echo "Displaying Unit Test Results for ${{ matrix.os }}"
          cat /tmp/test-results-${{ matrix.os }}/unit_test_output.txt || echo "No unit test results found for ${{ matrix.os }}"

      - name: Example DRM Test Results
        if: always()
        run: |
          echo "Displaying Example DRM test results for ${{ matrix.os }}"
          cat /tmp/test-results-${{ matrix.os }}/amd_smi_drm_ex.log || echo "No DRM example test results found for ${{ matrix.os }}"

      - name: Example NoDRM Test Results
        if: always()
        run: |
          echo "Displaying Example NoDRM test results for ${{ matrix.os }}"
          cat /tmp/test-results-${{ matrix.os }}/amd_smi_nodrm_ex.log || echo "No NoDRM example test results found for ${{ matrix.os }}"

  rpm-buildinstall:
    name: Build
    runs-on:
      - self-hosted
      - ${{ vars.RUNNER_TYPE }}
    continue-on-error: true
    strategy:
      matrix:
        os:
          - SLES
          - RHEL8
          - RHEL9
          - RHEL10
          - AzureLinux3
          - AlmaLinux8
    container:
      image: ${{ vars[format('{0}_DOCKER_IMAGE', matrix.os)] }}
      options: --privileged

    steps:
      - uses: actions/checkout@v4
        with:
          clean: false

      - name: Set PkgMgr
        run: |
          set -e
          case "${{ matrix.os }}" in
            SLES)
              echo "PACKAGE_MANAGER=zypper" >> $GITHUB_ENV
              ;;
            RHEL8|RHEL9|RHEL10|AlmaLinux8|AzureLinux3)
              echo "PACKAGE_MANAGER=dnf" >> $GITHUB_ENV
              ;;
          esac

      - name: Add more_itertools
        if: matrix.os == 'AzureLinux3'
        run: |
          set -e
          echo 'Installing more_itertools on ${{ matrix.os }}'
          python3 -m pip install more_itertools

      - name: Build AMDSMI for RHEL10
        if: matrix.os == 'RHEL10'
        run: |
          set -e
          echo 'Building on RHEL10 with retries'
          BUILD_FOLDER=$GITHUB_WORKSPACE/build
          RETRIES=3

          for i in $(seq 1 $RETRIES); do
            echo "Build attempt $i for RHEL10..."
            rm -rf $BUILD_FOLDER
            mkdir -p $BUILD_FOLDER
            cd $BUILD_FOLDER

            if cmake $GITHUB_WORKSPACE -DBUILD_TESTS=ON -DENABLE_ESMI_LIB=ON && \
               make -j $(nproc) && \
               make package; then
              echo "Build successful on attempt $i"
              break
            else
              echo "Build failed on attempt $i"
              if [ $i -eq $RETRIES ]; then
                echo "All $RETRIES build attempts failed. Exiting."
                exit 1
              fi
              sleep 30
            fi
          done
          echo "Build completed on RHEL10"

      - name: Build AMDSMI for other RPM distros
        if: matrix.os != 'RHEL10'
        run: |
          set -e
          echo 'Building on ${{ matrix.os }}'
          BUILD_FOLDER=$GITHUB_WORKSPACE/build
          rm -rf $BUILD_FOLDER
          mkdir -p $BUILD_FOLDER
          cd $BUILD_FOLDER
          cmake $GITHUB_WORKSPACE -DBUILD_TESTS=ON -DENABLE_ESMI_LIB=ON
          make -j $(nproc)
          make package
          echo "Build completed on ${{ matrix.os }}"

      - name: Install AMDSMI on RHEL10
        if: matrix.os == 'RHEL10'
        run: |
          cd $GITHUB_WORKSPACE/build
          dnf install python3-setuptools python3-wheel -y

          RETRIES=3
          for i in $(seq 1 $RETRIES); do
            echo "RHEL10: Installation attempt $i..."
            if timeout 10m dnf install -y --skip-broken --disablerepo=* ./amd-smi-lib-*99999-local*.rpm; then
              echo "Installation successful on attempt $i"
              ln -s /opt/rocm/bin/amd-smi /usr/local/bin
              # Verify Installation
              echo 'Verifying installation:'
              amd-smi version || true  # Continue even if this fails
              python3 -m pip list | grep amd || true
              python3 -m pip list | grep pip || true
              python3 -m pip list | grep setuptools || true
              echo 'Completed installation on RHEL10'
              break
            else
              echo "Installation failed on attempt $i"
              if [ $i -eq $RETRIES ]; then
                echo "All $RETRIES installation attempts failed. Exiting."
                exit 1
              fi
              sleep 30
            fi
          done

      - name: Install AMDSMI on other RPM distros
        if: matrix.os != 'RHEL10'
        run: |
          cd $GITHUB_WORKSPACE/build
          case ${{ env.PACKAGE_MANAGER }} in
            zypper)
              timeout 10m zypper --no-refresh --no-gpg-checks install -y ./amd-smi-lib-*99999-local*.rpm
              ;;
            dnf)
              dnf install python3-setuptools python3-wheel -y
              RETRIES=3
              for i in $(seq 1 $RETRIES); do
                echo "Attempt $i: Installing AMDSMI package..."
                if timeout 10m dnf install -y --skip-broken --disablerepo=* ./amd-smi-lib-*99999-local*.rpm; then
                  echo "AMDSMI package installed successfully."
                  break
                else
                  echo "Installation failed on attempt $i. Retrying..."
                  if [ $i -eq $RETRIES ]; then
                    echo "All $RETRIES attempts failed. Exiting."
                    exit 1
                  fi
                  sleep 10
                fi
              done
              ;;
          esac
          ln -s /opt/rocm/bin/amd-smi /usr/local/bin

          # Verify Installation
          echo 'Verifying installation:'
          amd-smi version
          python3 -m pip list | grep amd
          python3 -m pip list | grep pip
          python3 -m pip list | grep setuptools
          echo 'Completed installation on ${{ matrix.os }}'

      - name: Uninstall
        if: always()
        run: |
          set -e
          echo 'Uninstalling on ${{ matrix.os }}'
          case ${{ matrix.os }} in
            SLES)
              zypper remove -y amd-smi-lib || true
              ;;
            RHEL8|RHEL9|RHEL10|AlmaLinux8|AzureLinux3)
              dnf remove -y amd-smi-lib || true
              ;;
          esac
          rm -f /usr/local/bin/amd-smi
          if [ -d /opt/rocm/share/amd_smi ]; then
            echo '/opt/rocm/share/amd_smi exists. Removing.'
            rm -rf /opt/rocm/share/amd_smi
          fi
          echo 'Uninstall done on ${{ matrix.os }}'

  rpm-test:
    name: Tests
    needs: rpm-buildinstall
    runs-on:
      - self-hosted
      - ${{ vars.RUNNER_TYPE }}
    continue-on-error: true
    strategy:
      matrix:
        os:
          - SLES
          - RHEL8
          - RHEL9
          - RHEL10
          - AzureLinux3
          - AlmaLinux8
    container:
      image: ${{ vars[format('{0}_DOCKER_IMAGE', matrix.os)] }}
      options: --privileged

    steps:
      - uses: actions/checkout@v4
        with:
          clean: false

      - name: Set PkgMgr
        run: |
          set -e
          case "${{ matrix.os }}" in
            SLES)
              echo "PACKAGE_MANAGER=zypper" >> $GITHUB_ENV
              ;;
            RHEL8|RHEL9|RHEL10|AlmaLinux8|AzureLinux3)
              echo "PACKAGE_MANAGER=dnf" >> $GITHUB_ENV
              ;;
          esac

      - name: Add more_itertools
        if: matrix.os == 'AzureLinux3'
        run: |
          set -e
          echo 'Installing more_itertools on ${{ matrix.os }}'
          python3 -m pip install more_itertools

      - name: Build and Install for RHEL10 Test
        if: matrix.os == 'RHEL10'
        run: |
          set -e
          echo 'Building for test on RHEL10 with retries'
          BUILD_FOLDER=$GITHUB_WORKSPACE/build
          RETRIES=3

          for i in $(seq 1 $RETRIES); do
            echo "Build attempt $i for RHEL10 test..."
            rm -rf $BUILD_FOLDER
            mkdir -p $BUILD_FOLDER
            cd $BUILD_FOLDER

            if cmake $GITHUB_WORKSPACE -DBUILD_TESTS=ON -DENABLE_ESMI_LIB=ON && \
               make -j $(nproc) && \
               make package; then
              echo "Build successful on attempt $i"
              break
            else
              echo "Build failed on attempt $i"
              if [ $i -eq $RETRIES ]; then
                echo "All $RETRIES build attempts failed. Exiting."
                exit 1
              fi
              sleep 30
            fi
          done

          echo 'Installing for test on RHEL10'
          dnf install python3-setuptools python3-wheel -y

          for i in $(seq 1 $RETRIES); do
            echo "RHEL10: Installation attempt $i for test..."
            if timeout 10m dnf install -y --skip-broken --disablerepo=* $BUILD_FOLDER/amd-smi-lib-*99999-local*.rpm; then
              echo "Installation successful on attempt $i"
              ln -s /opt/rocm/bin/amd-smi /usr/local/bin
              echo 'Install done for test on RHEL10'
              break
            else
              echo "Installation failed on attempt $i"
              if [ $i -eq $RETRIES ]; then
                echo "All $RETRIES installation attempts failed. Exiting."
                exit 1
              fi
              sleep 30
            fi
          done

      - name: Build and Install for other RPM distros Test
        if: matrix.os != 'RHEL10'
        run: |
          set -e
          echo 'Building for test on ${{ matrix.os }}'
          BUILD_FOLDER=$GITHUB_WORKSPACE/build
          rm -rf $BUILD_FOLDER
          mkdir -p $BUILD_FOLDER
          cd $BUILD_FOLDER
          cmake $GITHUB_WORKSPACE -DBUILD_TESTS=ON -DENABLE_ESMI_LIB=ON
          make -j $(nproc)
          make package

          echo 'Installing for test on ${{ matrix.os }}'
          case ${{ env.PACKAGE_MANAGER }} in
            zypper)
              timeout 10m zypper --no-refresh --no-gpg-checks install -y $BUILD_FOLDER/amd-smi-lib-*99999-local*.rpm
              ;;
            dnf)
              dnf install python3-setuptools python3-wheel -y
              RETRIES=3
              for i in $(seq 1 $RETRIES); do
                echo "Attempt $i: Installing..."
                if timeout 10m dnf install -y --skip-broken --disablerepo=* $BUILD_FOLDER/amd-smi-lib-*99999-local*.rpm; then
                  echo "Install successful."
                  break
                else
                  echo "Attempt $i failed. Retrying..."
                  if [ $i -eq $RETRIES ]; then
                    echo "All attempts failed."
                    exit 1
                  fi
                  sleep 10
                fi
              done
              ;;
          esac
          ln -s /opt/rocm/bin/amd-smi /usr/local/bin
          echo 'Install done for test on ${{ matrix.os }}'

      - name: AMDSMI Command Tests
        shell: bash
        run: |
          set -e
          echo "Running AMDSMI commands on ${{ matrix.os }}"
          mkdir -p /tmp/test-results-${{ matrix.os }}
          commands=(
            "amd-smi version"
            "amd-smi list"
            "amd-smi static"
            "amd-smi firmware"
            "amd-smi bad-pages"
            "amd-smi metric"
            "amd-smi process"
            "amd-smi topology"
            "amd-smi monitor"
            "amd-smi xgmi"
            "amd-smi partition"
          )
          for cmd in "${commands[@]}"; do
            echo "Running: $cmd"
            if ! $cmd > /tmp/test-results-${{ matrix.os }}/$(echo $cmd | tr ' ' '_').log 2>&1; then
              echo "Command '$cmd' failed."
              cat /tmp/test-results-${{ matrix.os }}/$(echo $cmd | tr ' ' '_').log
              exit 1
            else
              echo "$cmd passed."
            fi
          done
          echo "AMDSMI commands done on ${{ matrix.os }}"

      - name: Run AMDSMI, Python, and Example Tests
        shell: bash
        run: |
          set -e
          echo 'Running other tests on ${{ matrix.os }}'

          # AMDSMI Tests
          echo 'AMDSMI tests'
          cd /opt/rocm/share/amd_smi/tests
          source amdsmitst.exclude
          ./amdsmitst --gtest_filter="-$(echo ${BLACKLIST_ALL_ASICS})" > /tmp/test-results-${{ matrix.os }}/amdsmi_tests.log 2>&1
          if [ $? -ne 0 ]; then
            echo "AMDSMI tests failed"
            exit 1
          fi
          echo "AMDSMI tests done"

          # Python Tests
          echo 'Python tests'
          cd /opt/rocm/share/amd_smi/tests/python_unittest
          ./integration_test.py -v > /tmp/test-results-${{ matrix.os }}/integration_test_output.txt 2>&1
          ./unit_tests.py -v > /tmp/test-results-${{ matrix.os }}/unit_test_output.txt 2>&1
          echo "Python tests done"

          # Example Tests
          echo 'Example tests'
          cd $GITHUB_WORKSPACE/example
          rm -rf build
          cmake -B build -DENABLE_ESMI_LIB=OFF
          make -C build -j $(nproc)
          cd build
          ./amd_smi_drm_ex > /tmp/test-results-${{ matrix.os }}/amd_smi_drm_ex.log 2>&1 || echo 'amd_smi_drm_ex failed'
          ./amd_smi_nodrm_ex > /tmp/test-results-${{ matrix.os }}/amd_smi_nodrm_ex.log 2>&1 || echo 'amd_smi_nodrm_ex failed'
          echo "Example tests done"

      - name: AMDSMI Test Results
        if: always()
        run: |
          echo "Displaying AMDSMI test results for ${{ matrix.os }}"
          cat /tmp/test-results-${{ matrix.os }}/amdsmi_tests.log || echo "No AMDSMI test results found for ${{ matrix.os }}"

      - name: Integration Test Results
        if: always()
        run: |
          echo "Displaying Integration test results for ${{ matrix.os }}"
          cat /tmp/test-results-${{ matrix.os }}/integration_test_output.txt || echo "No integration test results found for ${{ matrix.os }}"

      - name: Unit Test Results
        if: always()
        run: |
          echo "Displaying Unit Test Results for ${{ matrix.os }}"
          cat /tmp/test-results-${{ matrix.os }}/unit_test_output.txt || echo "No unit test results found for ${{ matrix.os }}"

      - name: Example DRM Test Results
        if: always()
        run: |
          echo "Displaying Example DRM test results for ${{ matrix.os }}"
          cat /tmp/test-results-${{ matrix.os }}/amd_smi_drm_ex.log || echo "No DRM example test results found for ${{ matrix.os }}"

      - name: Example NoDRM Test Results
        if: always()
        run: |
          echo "Displaying Example NoDRM test results for ${{ matrix.os }}"
          cat /tmp/test-results-${{ matrix.os }}/amd_smi_nodrm_ex.log || echo "No NoDRM example test results found for ${{ matrix.os }}"
